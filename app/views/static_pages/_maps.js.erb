var square = <%= @square %>;
handler = Gmaps.build('Google');
handler.buildMap({
    provider: {
        disableDefaultUI: true,
        zoom: 15
    },
    internal: {
        id: 'map'
    }
},
function(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(displayOnMap, defaultLocation);
        navigator.geolocation.getCurrentPosition(setMarkers, defaultLocation);
    }
});

function defaultLocation(){
    var senac = { 
        coords: {
            latitude: -30.03518581,
            longitude: -51.22660625
        }
    };
    displayOnMap(senac);
    setMarkers(senac);
};

function displayOnMap(position){
    var marker = handler.addMarker({
        lat: position.coords.latitude,
        lng: position.coords.longitude    
    });

    handler.map.centerOn(marker);

    var circles = handler.addCircles(
        [{ lat: position.coords.latitude, lng: position.coords.longitude, radius: square }],
        { strokeColor: '#FF0000'}
    );
    handler.bounds.extendWith(circles);
};

function setMarkers(position){
    var addressLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
    
    var pets = <%=raw @hash.to_json %>;
    var arrayPets = [];

    $.each(pets, function(index, pet) {
        var addressPet = new google.maps.LatLng(pet.lat,pet.lng);
        var distance = google.maps.geometry.spherical.computeDistanceBetween(addressLocation, addressPet);
        
        if (distance <= square)
            arrayPets.push(pet);
    });

    markers = handler.addMarkers(arrayPets); 
    handler.bounds.extendWith(markers);
    handler.fitMapToBounds();
};